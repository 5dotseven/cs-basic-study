### 트랜잭션 격리수준 **(Isolation Level)**

- **격리수준 :** 한 트랜잭션이 **다른 트랜잭션이 변경한 데이터**에 대한 접근 강도 <br></br>
- **격리 수준의 필요성**
  - 데이터베이스는 ACID 특징과 같이 트랜잭션이 독립적인 수행을 하도록 한다.
  - 따라서 Locking을 통해, 트랜잭션이 DB를 다루는 동안 다른 트랜잭션이 관여하지 못하도록 막는 것이 필요하다.
  - 즉, 트랜잭션 수준 읽기 일관성(Transaction-Level Read Consistency)을 지키기 위함  ->동시성 제어 문제 해결

    무조건 **Locking**으로 동시에 수행되는 수많은 트랜잭션들을 **순서대로** 처리하는 방식으로 구현하게 되면 데이터베이스의 **성능은 떨어지게** 될 것이다.

    그렇다고 해서, **성능을 높이기 위해 Locking의 범위를 줄인다**면, **잘못된 값이 처리**될 문제가 발생<br></br>

  - Lock : 트랜잭션의 순차성을 보장하기 위한 방법(동시성 제어)
      - 공유(Shared) Lock : 데이터를 읽을 때 사용되는 lock
          - 공유 Lock끼리 동시 접근 가능
          - 공유 Lcok 설정된 데이터에 베타락 사용 불가
      - 배타(Exclusive) Lock : 데이터를 변경할 때 사용, 트랜잭션이 완료 될 때까지 유지
          - Lock이 해제될 때까지 다른 트랜잭션은 해당 리소스에 접근 불가
          - 해당 Lock은 트랜잭션이 수행되고 있는 데이터에 대해서는 접근하여 함께 Lock 설정 불가<br></br>

- 트랜잭션 격리수준

![Untitled](https://github.com/5dotseven/cs-basic-study/assets/118906074/7860c0b2-a671-4f32-97c2-9e2c3686d7a3)

- **READ UNCOMMITTED(Lv 0)**
    - 특징
        - SELECT 문이 수행되는 동안 해당 데이터에 Shared Lock이 걸리지 않는 계층
        - 어떤 트랜잭션의 변경내용이 COMMIT이나 ROLLBACK과 상관없이 다른 트랜잭션에서 보여지는 것
        - 트랜잭션에 처리중이거나, 아직 Commit 되지 않은 데이터를 다른 트랜잭션이 읽는 것 허용
    - **DIRTY READ** 발생
        - Dirty Read : 트랜잭션이 작업이 완료되지 않았는데도 다른 트랜잭션에서 볼 수 있게 되는 현상
        - Ex)
            - A 트랜잭션에서 10번 사원 나이를 27 → 28로 변경 . Commit 하지 않은 상태
            - B 트랜잭션에서 10번 사원 나이 조회: 결과 28 → Dirty Read 발생
                - 이후 A트랜잭션에서 문제 발생하여 Rollback
                - B 트랜잭션은 10번 사원의 나이 = 28로 알고 로직 수행
                  → 데이터 정합성에 문제 발생<br></br>
- **READ COMMITTED(Lv 1)**
    - 특징
        - SELECT 문이 수행되는 동안 해당 데이터에 Shared Lock이 걸리는 계층
        - 트랜잭션의 변경 내용이 COMMIT 되어야만 다른 트랜잭션에서 조회할 수 있다
        - 트랜잭션이 수행되는 동안 다른 트랜잭션이 접근할 수 없어 대기
        - RDB에서 대부분 기본적으로 사용되고 있는 격리 수준<br></br>
    - **NON-REPEATABLE READ 발생**
        - **NON-REPEATABLE READ :** 하나의 트랜잭션 내에서 동일한 SELECT 쿼리를 실행했을 때 항상 같은 결과를 보장해야 한다는 REPEATABLE READ 정합성에 어긋나는 것
        - Ex)
            - B 트랜잭션에서 10번 사원 나이 조회 : 결과 27
            - A 트랜잭션에서 10번 사원 나이를 27 → 28 변경 후 커밋
            - B 트랜잭션에서 10번 사원 나이 조회 : 결과 28
              →**같은 조회(셀렉트)문인데도 결과가 다르기 때문에 정합성에 어긋난다.**<br></br>
- **REPEATABLE READ (Lv 2)**
    - 특징
        - 트랜잭션이 완료될 때까지 Select문이 사용되는 모든 데이터에 Shared Lock이 걸리는 계층
        - 자신의 트랜잭션이 생성되기 이전의 트랜잭션에서 COMMIT 이 된 데이터만 읽음
        - 트랜잭션이 범위 내에서 조회한 데이터 내용이 항상 동일함을 보장
        - 다른 사용자는 트랜잭션 영역에 해당하는 데이터에 대한 수정 불가
        - MySQL과 MariaDB 가 기본으로 사용하는 격리 수준
        - MySQL에서는 트랜잭션마다 트랜잭션 ID를 부여하여 트랜잭션 ID보다 작은 트랜잭션 번호에서 변경한 것만 읽게 된다.
        - **NON-REPEATABLE READ 부정합 발생 X**
        - Phantom Read 발생
            - 한 트랜잭션 안에서 일정 범위의 레코드를 두 번 이상 읽었을 때, 첫번째 쿼리에 없던 레코드가 두번째 쿼리에서 나타나는 현상
            - 트랜잭션 도중 새로운 레코드 삽입을 허용하여 발생<br></br>
- **SERIALIZABLE (Lv 3)**
    - 특징
        - 트랜잭션이 완료될 때까지 Select문이 사용되는 모든 데이터에 Shared Lock이 걸리는 계층
        - 가장 단순한 격리 수준이지만 가장 엄격한 격리 수준
        - SERIALIZABLE에서는 PHANTOM READ가 발생하지 않는다.
        - 성능 문제로 데이터베이스에서 거의 사용되지 않는다.<br></br>
- **트랜잭션 문제점 요약**
    - **Dirty Read**
        - 아직 **커밋(Commit)되지 않은** 다른 트랜잭션의 데이터를 읽는 것<br></br>
    - **Non-repeatable Read**
        - 다른 트랜잭션이 커밋(Commit)한 데이터를 읽을 수 있는 것을 의미
        - 즉, 한 트랜잭션에서 같은 쿼리로 2번이상 조회했을 때 **그 결과가 상이한 상황**
        - 보통 데이터의 수정/삭제가 발생했을 경우 발생<br></br>
    - **Phantom Read**
        - 다른 트랜잭션이 커밋(Commit)한 데이터가 있더라도 자신의 트랜잭션에서 읽었던 내용만 사용하는 것
        - 즉, 한 트랜잭션에서 같은 쿼리를 2번이상 **조회했을 때 없던 결과가 조회**되는 상황
        - 보통 데이터의 삽입이 발생했을 경우 발생<br></br>

- **트랜잭션 격리 수준에따른 동시성과 일관성 변화**

  ![Untitled (3)](https://github.com/5dotseven/cs-basic-study/assets/118906074/6675fb21-ca26-4643-b5a6-0860279fc05e)

    - 격리 수준이 높아지면서 데이터의 일관성이 유지될 수 있지만, 동시에 처리가능한 트랜잭션의 양은 떨어집니다. 격리수준이 낮아지면 일관성은 유지되기 어렵지만, 동시에 처리할 수 있는 트랜잭션의 양은 늘어나게 됩니다.
        - **동시성** : 동시에 수행하는 트랜잭션 양
        - **일관성** : 트랜잭션의 작업 처리 결과가 항상 일관성이 있어야 한다는 것

출처

- [https://velog.io/@wonizizi99/CS-트랜잭션-Transaction](https://velog.io/@wonizizi99/CS-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-Transaction)
- [https://velog.io/@yujiniii/데이터베이스-트랜잭션-격리-수준](https://velog.io/@yujiniii/%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EA%B2%A9%EB%A6%AC-%EC%88%98%EC%A4%80)
- https://dar0m.tistory.com/225