# 로드밸런싱

## 정의

서버 부하 분산이라고 일컬으며 서버에 몰리는 트래픽을 여러 서버로 **분산 처리** 한다.

이때 특정 서버에 트래픽이 몰리는것을 방지하지 않도록 적절히 분산하여야 하며 이 기술을 로드밸런싱이라 한다.

![image](https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F552fe0dc-fdb3-4c62-979e-df2a2e235613%2F0494066a-99aa-42a9-bfa3-b3810eb7ca67%2FUntitled.png?table=block&id=9349dc26-b31c-4068-a520-1c52d0e01a27&spaceId=552fe0dc-fdb3-4c62-979e-df2a2e235613&width=2000&userId=a09a1ca3-4214-4905-a7a2-172e60f8cd39&cache=v2)

## 로드밸런싱의 종류

로드밸런싱에는 **L4로드밸런싱**과 **L7로드밸런싱**이 많이 사용된다.

**L4**와 **L7**은 **OSI 7계층**의 어떤 계층을 기준으로 이루어지는지에 따라 나뉜다.

**(4계층 ⇒ 전송계층 / 7계층 ⇒ 응용계층)**

L4 로드밸런싱

- 전송계층(TCP, UDP) 프로토콜의 헤더를 부하 분산에서 이용한다.
    
    ⇒ IP 주소, 포트번호, MAC 주소, 전송 프로토콜 등에 따라 트래픽을 분산
    
- 트래픽을 전송계층의 로드밸런서가 받아 서버의 트래픽 부하 분산을 해준다.
- L4로드밸런서는 네트워크 계층이나 전송 계층의 해더 정보를 바탕으로 분산처리 한다.

장점

- 패킷의 내용을 확인하지 않고 분산 할 수 있어 속도가 빠르다
- 데이터를 복호화 하지 않음으로 안전하다.
- L7에 비해 저렴하다

단점

- 패킷을 열어볼 수 없음으로 세세한 라우팅을 통한 분산이 불가능하다.
- 사용자의 IP가 자주 바뀌면 연속적으로 서비스하기가 어렵다.

L7 로드밸런싱

- 응용계층(HTTP, FTP, SMTP 등)의 로드밸런서가 부하 분산한다.
    
    ⇒ HTTP 헤더, Cookie 등과 같은 사용자 요청 정보를 기반으로 트래픽 분산이 가능하다.
    
- L4 로드밸런서 기능에 패킷을 확인하여 특정 서버로 분산하는 것까지 가능하다.
- 특정 패턴의 바이러스를 감지할 수 있어 네트워크 보안이 가능하다.
- DDos와 같은 비정상 트래픽을 감지 가능하다.

방식

- URL 스위칭
    - URL 구조를 기반으로 부하분산한다.
    - 예시) user/* , image/*
- 컨텍스트 스위칭
    - 클라이언트가 요청한 리소스에 해당하는 서버로 연결
- 쿠키 지속성
    - 쿠키 정보를 바탕으로 클라이언트가 연결했던 서버에 지속적으로 연결해주는 방식

장점

- 4계층에서 한번 7계층에서 한번 분산하기 때문에 더욱 상세하게 라우팅이 가능
- 캐싱 기능 제공이 가능하다
- 비정상 트래픽을 감지할 수 있어 안정성이 높다.

단점

- L4에 비하여 비싸다.
- 패킷 복호화 비용이 든다.

## 로드밸런싱 기법

### 1)라운드 로빈

- 순차적으로 돌며 세션을 할당하는 방식
- 요청을 순서대로 분배하기 때문에 서버의 스팩이 동일하고 세션이 오래 가지 않을 때 적합함

### 2) 가중 라운드 로빈

- 라운드 로빈 방식에서 서버마다 가중치를 설정하여 ㅅ할당하는 방식

### 3) IP 해시 방식

- 클라이언트의 IP 주소를 특정 서버로 매핑하는 방식
- 사용자가 항상 동일한 서버로 매핑되도록 함
- 접속자가 많을수록 분산 효율이 뛰어나다.

### 4) 최소 연결 방식

- 세션이 가장 적은 서버에 요청을 우선 할당하는 방식
- 세션이 자주 길어지거나 서버에 분배된 트래픽이 일정하지 않으면 유리

### 5) 최소 응답시간 방식

- 서버의 현재 연결상태와 응답시간을 고려하여 응답시간이 짧은 서버로 할당하는 방식
- 서버들의 리소스나 처리중인 데이터량이 크게 다를수록 적합하다.

### 6) 대역폭 방식

- 서버의 대역폭 사용량을 기반으로 서버에 할당하는 방식

## 로드밸런싱의 기능

### 1) Health Check

- 서버에 대한 상태를 주기적으로 확인하고 서버의 장애 상태를 파악하여 정상 작동 중인 서버로만 트래픽을 보낸다.
- L3 체크 : IP 주소가 통신 가능한 상태인지 확인한다 (*ICMP , *PING)
- L4 체크 : TCP의 3way-hanshaking을 통한 통신 가능 상태를 확인한다.
- L7 체크 : 애플리케이션의 실제 URL 로 통신하여 통신 가능 상태를 확인한다.

### 2) Tunneling

- 데이터를 캡슐화하여 연결되어진 서로 연결된 노드만 그 데이터의 캡슐을 복호화 할 수 있게 한다

### 3) NAT(Network Address Translation)

- 사설 IP와 로드밸런서의 공인 IP 주소간의 매핑
    
    ⇒ 1개의 공인IP 에 N개의 사설IP가 붙어있는 형태
    
    - **SNAT(Source Network Address Translation)** : 내부에서 외부로 트래픽이 나갈 때
    - **DNAT(Destination Network Address Translation)** : 외부에서 내부로 트래픽이 들어올 때

### 4) DSR(Destination Network Address Translatioin)

- 서버에서 클라이언트로 응답을 내보낼 때 네트워크 장비나 로드밸런서를 거치치 않고 바로 클라이언트로 갈 수 있게 하는 방법