### 교착상태(Deadlock)의 개념과 조건

- Deadlock
    - 프로세스가 자원을 얻지 못해 다음 처리를 하지 못하는 상태
    - 시스템적으로 한정된 자원을 여러 곳에서 사용하려고 할 때 발생

  ![Untitled](https://github.com/5dotseven/cs-basic-study/assets/118906074/5723d9dc-3b09-42e3-a33b-a660d6dfec3a)

    - p1과 p2가 리소스1,2 둘 다를 얻어야 한다고 가정할 때,  
      t1에 p1이 리소스 1을 얻고, p2가 리소스 2를 얻었다면,  
      t2때 p1은 리소스 2를, p2는 리소스 1을 기다리게 된다.  
      하지만 서로 원하는 리소스가 상대방에게 할당되어 있어, 이 두 프로세스는 무한정 기다리게 됨<br></br>
- 발생 조건
    - 교착 상태는 한 시스템 내에서 다음의 **4가지 조건이 동시에 성립**할 때 발생한다.
    1. **상호 배제(Mutual Exclusion)**

       : 자원은 한 번에 한 프로세스만이 사용할 수 있어야 한다.

    2. **점유 대기 (Hold and Wait)**

       : 최소한 하나의 자원을 점유하고 있으면서 다른 프로세스에 할당되어 사용되고 있는 자원을 추가로 점유하기 위해 대기하는 프로세스가 있어야 한다.
       즉, 이미 자원을 사용중인데, 다른 프로세스가 사용중인 자원을 사용하기 위해 대기하고 있는 상태의 프로세스가 존재해야 한다.

    3. **비선점 (No preemption)**

       : 다른 프로세스에 할당된 자원은 사용이 끝날 때까지 강제로 빼앗을 수 없어야 한다.

    4. **순환 대기 (Circular wait)**

       :  프로세스의 자원 점유 및 점유된 자원의 요구 관계가 원형을 이루면서 대기하는 조건.
       각 프로세스는 순환적으로 다음 프로세스가 요구하는 자원을 가지고 있음
       프로세스의 집합에서 P0은 P1이 점유한 자원을 대기하고 P1은 P2가 점유한 자원을 대기하 고,  P2...Pn-1d은 Pn이 점유한 자원을 대기하며 Pn은 P0이 점유한 자원을 요구해야 한다.

- **예방(Prevention)**
    - 교착상태가 애초에 일어나지 않도록 방지하는 방법으로 교착상태의 발생조건 4가지 중 하나를 부정함으로써 교착상태를 예방

    - **상호 배제 부정**
        - 여러 개의 프로세스가 동시에 공유자원을 사용할 수 있음
    - **점유 대기 부정**
        - 프로세스가 실행되기 전에 필요한 모든 자원을 할당하여 프로세스 대기를 없애거나, 자원이 점유되지 않은 상태에서만 자원 요청을 받도록 함
    - **비선점 부정**
        - 모든 자원에 대한 선점을 허용
    - **순환 대기 부정**
        - 자원을 선형으로 분류하여 고유 번호를 할당하고, 각 프로세스는 현재 점유한 자원의 고유번호보다 앞이나 뒤 한쪽 방향으로만 자원을 요구하도록 함

       → 그러나 이렇게 교착상태 발생조건을 방지해서 데드락을 예방하는 방법은 시스템 처리량이나 자원 사용의 효율성을 떨어트림<br></br>

- **회피(Avoidance)**
    - 교착상태가 발생할 가능성이 있는 자원 할당(Unsafe allocation)을 하지 않고 안전한 상태(Safe state)에서만 자원 요청을 허용하는 방법입니다. 하지만 교착상태 회피를 하기 위해서는 아래와 같은 가정이 필요합니다.
        - **프로세스 수 고정**
        - **자원의 종류와 수 고정**
        - **프로세스가 요구하는 최대 자원의 수를 알아야 함**
        - **프로세스는 자원 사용 후 반드시 반납**
      <details>
        <summary>Safe & Unsafe state</summary>
        <div markdown="1">Safe state: safe sequence(교착상태를 발생시키지 않고 자원을 할당하는 순서)가 존재하며 모든 프로세스가 정상적으로 종료될 수 있는 상태를 의미<br></br>  
      Unsafe state: 교착상태가 발생할 가능성이 있는 상태
        </div>
      </details><br></br>  

    - **회피 알고리즘**
        - **은행원 알고리즘**
            - 프로세스의 자원 요구시, 자원할당 후에도 안정상태로 남아 있는지 사전에 검사하여 데드락을 회피
            - 안정상태를 유지하면 자원할당, 아니면 다른 프로세스들이 자원 해지까지 대기<br></br>
            - 요소
                - **최대 요구량(Maximum Demand):** 각 프로세스가 실행을 완료하기 위해 요구할 수 있는 자원의 최대량입니다.
                - **할당량(Allocation):** 현재 각 프로세스에게 할당된 자원의 양입니다.
                - **필요량(Need):** 각 프로세스가 요구할 수 있는 최대 자원에서 현재 할당된 자원을 뺀 양입니다. 필요량 = 최대 요구량 - 할당량.
                - **가용량(Available):** 시스템에서 현재 사용 가능한 자원의 양입니다.<br></br>
            - **<예시>** 시스템은 총 12개의 자원을 가지고 있다고 가정
            
          | (t=t0) | 최대 자원 요구량 | 할당중인 자원량 | 남은 필요한 자원의 양 |
                      | --- | --- | --- | --- |
          | P0 | 10 | 5 | 5 |
          | P1 | 4 | 2 | 2 |
          | P2 | 9 | 2 | 7 |
            - 현재 할당 중인 자원량의 합 은 **5+2+2 = 9** 입니다. 시스템은 총 12개의 자원을 가지고 있으므로 현재 상태에서 가용 자원량은 **12 - 9 = 3** 이 됩니다.
            - 여기서 가용자원을 어느 프로세스에게 할당해주느냐에 따라서 자원을 효율적으로 이용할 수 있게 됩니다.
                - 남은 가용자원 3개를 P1에게 할당 => **가용자원은 3 - 2 = 1**
                - P1의 작업이 끝나고 할당되어 있던 자원 4개 반납 => **가용자원은 1 + 4 = 5**
                - 남은 가용자원 5개를 P0에게 할당 => **가용자원은 5 - 5 = 0**
                - P0의 작업이 끝나고 할당되어 있던 자원 10개 반납 => **가용자원은 0 + 10 = 10**
                - 남은 가용자원 10개 중 7개를 P2에게 할당 => **가용자원은 10 - 7 = 3**
                - P2의 작업이 끝나고 할당되어 있던 자원 9개 반납 => **가용자원은 3 + 9 = 12**

              → 이렇게 P1 - P0 - P2 순서로 자원 할당 시 Safe sequence를 만족하게 됩니다.<br></br>

    - **탐지(Detection)**
        - 데드락 발생을 허용하여 자원할당 그래프나 탐지 알고리즘 등을 통해 유발 프로세스를 찾아내 해결
          교착상태가 탐지되었다면 회복 기법을 통해 교착상태를 복구합니다.
        - 그러나 탐지 기법은 지속적으로 교착상태를 확인하는 작업이 필요하기 때문에 오버헤드(성능 저하)가 발생하게 됩니다.<br></br>
    - **회복(Recovery)**
        - 교착상태의 프로세스를 종료하거나 할당 자원을 해제함으로서 회복

        - **사용자 처리**
            - 교착상태에 있는 프로세스 중 하나의 프로세스를 사용자가 강제 종료

        - **시스템 처리**
            - **프로세스 중지**
                - 교착상태에 속해있는 모든 프로세스를 중지
                - 교착상태가 해결될 때까지 한 프로세스씩 중지
            - **자원 선점**
                - 프로세스들로부터 자원을 빼앗아 교착상태가 해결될 때까지 다른 프로세스들에게 자원을 할당

출처

- https://cocoon1787.tistory.com/858
- [https://velog.io/@dl_edge/운영체제-교착상태-4가지-조건](https://velog.io/@dl_edge/%EC%9A%B4%EC%98%81%EC%B2%B4%EC%A0%9C-%EA%B5%90%EC%B0%A9%EC%83%81%ED%83%9C-4%EA%B0%80%EC%A7%80-%EC%A1%B0%EA%B1%B4)